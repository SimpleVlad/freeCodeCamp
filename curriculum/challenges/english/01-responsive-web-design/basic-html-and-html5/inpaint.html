<html>
<head>
<meta charset="utf-8">
<title>CVdrawing</title>
</head>
<body>
<p id="status">OpenCV.js is loading...</p>
<canvas id="canvas" >
</canvas>
<img id="src" src="bird.jpg" style="display:none"/>
<input type="button" id="myButton" value="Test" disabled=true
onclick="inpaint()"/>

<script type="text/javascript">

var src;
var mask;
var lastX;
var lastY;

window.onload = function()
{
context = document.getElementById("canvas").getContext("2d");
img = document.getElementById("src");
context.canvas.width = img.width;
context.canvas.height = img.height;
context.drawImage(img, 0, 0);
};

document.getElementById("canvas").onmousedown = function(e)
{
  lastX = e.pageX - this.offsetLeft;
  lastY = e.pageY - this.offsetTop;
};

document.getElementById("canvas").onmousemove = function(e)
{
  if (lastX != undefined)
  {
    let x = e.pageX - this.offsetLeft;
    let y = e.pageY - this.offsetTop;
    cv.line(src, new cv.Point(lastX, lastY), new cv.Point(x, y),
    new cv.Scalar(255, 255, 255, 255), 2);
    cv.line(mask, new cv.Point(lastX, lastY), new cv.Point(x, y),
    new cv.Scalar(255, 255, 255, 255), 2);
    cv.imshow("canvas", src);
    lastX = x;
    lastY = y;
  }
};

document.getElementById("canvas").onmouseup =
document.getElementById("canvas").onmouseleave = function(e)
{
    lastX = undefined;
    lastY = undefined;
};

function init()
{
  let rgba = cv.imread("src");
  src = new cv.Mat();
  cv.cvtColor(rgba, src, cv.COLOR_RGBA2RGB);
  mask = new cv.Mat.zeros(src.size(), cv.CV_8UC1);
  rgba.delete();
}

function inpaint()
{
  let dst = new cv.Mat();
  cv.inpaint(src, mask, dst, 3, cv.INPAINT_TELEA);
  cv.imshow("canvas", dst);
  src.delete();
  mask.delete();
  dst.delete();
}

function onOpenCvReady()
{
  document.getElementById("status").innerHTML = "OpenCV.js is ready.";
  cv["onRuntimeInitialized"] = () =>
  {
    document.getElementById("myButton").disabled = false;
    init();
  }
}

</script>

<script async src="opencv.js" onload="onOpenCvReady();" type="text/javascript">
</script>

</body>
</html>
